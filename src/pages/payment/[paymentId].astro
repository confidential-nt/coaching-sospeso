---
import { paymentApi, paymentRepo } from "@/actions";
import Layout from "@/layouts/Layout.astro";
import { parseRouteParamsFromUrl } from "@/routing/parseRouteParams";

const session = Astro.locals.session;

if (!session) {
  // TODO! 로그인 페이지로 리다이렉트 시키기
  //  https://docs.astro.build/en/guides/routing/#dynamic-redirects
  return Astro.redirect("/auth/login");
}

const { paymentId } = parseRouteParamsFromUrl(
  "소스페소-결제",
  new URL(Astro.url),
);

const payment = await paymentRepo.retrievePayment(paymentId);

const { paymentLink } = await paymentApi.generatePaymentLink(payment);
---

<Layout title="소스페소 발행하기">
  {
    paymentLink && (
      <div>
        <h2>결제를 진행해주세요.</h2>{" "}
        <a class="btn btn-primary" href={paymentLink} target="_blank">
          결제 진행하기
        </a>
      </div>
    )
  }
</Layout>
