---
import { LoginForm } from "@/components/auth/LoginForm.tsx";
import Layout from "@/layouts/Layout.astro";
---

<Layout title="코칭 소스페소 로그인">
  <LoginForm client:load />
</Layout>

<script>
  import { authApi } from "@/adapters/authApi.ts";
  import { toastifyToastApi } from "@/adapters/toastApi.tsx";
  import { magicLinkLoginBus } from "@/components/auth/LoginForm.tsx";
  import { href } from "@/routing/href";
  import { navigate } from "astro:transitions/client";

  const toastApi = toastifyToastApi;

  magicLinkLoginBus.on(window.document.body, (command) => {
    authApi.login.emailPassword(command).then((result) => {
      if (result === "success") {
        navigate(href("홈", { page: 1 }));
        return;
      }

      if (result === "invalid-email-or-password") {
        toastApi.toast("이메일이나 비밀번호를 확인해주세요!", "error");

        return;
      }

      if (result === "email-not-verified") {
        authApi.sendEmailVerification({ email: command.email });
        toastApi.toast(
          "아직 인증이 되지 않았어요. 인증 이메일을 다시 전송했으니, 확인해주세요.",
          "error",
        );

        return;
      }
      toastApi.toast("알 수 없는 에러!", "error");
    });
  });
</script>
