# 스키마 : valibot

상태 : proposed

## 역사

### 2024년 10월 18일 탐정토끼가 일단 valibot을 들여옴

## 맥락과 이유

type을 정적으로 체크하든 동적으로 체크하든 schema는 필수적입니다. 특히 form에 사용자의 입력이나, api 요청, URL에 들어오는 파라미터 등은 의심부터 하고 봐야 합니다. [검증하지 말고 파싱하라](https://eatchangmyeong.github.io/2022/12/04/parse-don-t-validate.html)는 원칙을 따라서 외부에서 들어온 값들을 안전하게 검사해야 합니다.

typescript 생태계에 schema 라이브러리는 많습니다. joi 나 yup도 있고, json schema 기반의 ajv, typebox, zod, 컴파일러 기반인 typia 최근에 나온 valibot까지... 이들은 각자 다른 트레이드 오프를 가지고 있는데요.

저희 맥락을 정리하면 이렇습니다.

일단 저희는 서버리스로 배포할 것이고 프론트에서도 용량이 적었으면 좋겠습니다.

Typia 등은 type으로 스키마를 정의할 수 있는 점은 편리하지만, 컴파일 방식의 특성상 스키마의 개수를 따라 용량이 늘어나는 단점이 있습니다.

zod. ajv 등의 라이브러리는 구조상 트리쉐이킹이 어렵습니다.

클라이언트에서 실행하는 경우에 검증은 그렇게 자주 일어나지 않고, 성능이 크게 문제가 되진 않습니다.

서버에서 실행하는 경우에는 성능이 중요합니다. 프로덕션에서의 경험을 돌이켜보면, 대용량의 데이터에 스키마 검증을 하면 서버 CPU를 잡아먹은 큰 병목이 되고는 했습니다.

joi나 yup 같은 옛 라이브러리는 이러한 이유로 제외합니다.

## 결정

valibot으로 결정합니다. valibot은 트리쉐이킹을 염두에 두고 설계되어서 용량을 적게 차지하고요. ajv 등과 달리 zod와 비슷하게 사용하기도 쉽고 typescript 지원도 잘 됩니다.

typia나 typebox보다는 느리지만, zod보다는 빠릅니다.

## 유보

아직 astro의 action은 zod만 지원하고 있습니다. input 검증을 직접 깎아서 valibot을 이용할 수 있게 만들 예정입니다.
